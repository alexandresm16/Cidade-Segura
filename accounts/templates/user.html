{% block head %}
{% include "head.html" %}
{% include "index.html" %}
{% endblock %}
{% load static %}
{% block content %}
{% load django_bootstrap5 %}
{% bootstrap_messages %}

<div class="m-5 text-center">
	<h1><u> Minhas denúncias </u></h1>
</div>
<div class="row d-flex justify-content-center m-5">
	{% for occurrence in occurrences %}
	<div class="text-center card m-2 col-4" style="width: 18rem;">
		<div id="map-{{ occurrence.id }}" style="height: 180px;"></div>
		<form class="py-2" action="{% url 'occurrence_delete' occurrence.id %}" method="post">
			{% csrf_token %}

			<div class="d-flex justify-content-center">
				<button class="btn btn-danger btn-sm mt-2"
				        data-bs-target="#deleteModal{{ occurrence.id }}"
				        data-bs-toggle="modal"
				        type="button">
					Excluir Denúncia
				</button>
			</div>
		</form>

		<div class="card-body">
			<h5 class="h4 card-title">{{ occurrence.get_crime_type_display }}</h5>

            <hr>

			<p class="card-text">
				<strong>Descrição:</strong><br>
				{{ occurrence.description|default:"Não informado" }}
			</p>

			<p class="card-text">
				<strong>Referência:</strong><br>
				{{ occurrence.reference|default:"Não informado" }}
			</p>

            <p class="card-text">
				<strong>Denuncia ocorrida na data de:</strong><br>
				{{ occurrence.occurred_at|date:"d/m/Y H:i" }}
			</p>

            <p class="card-text">
				<strong>Denuncia realizada em:</strong><br>
				{{ occurrence.created_at|date:"d/m/Y" }}
			</p>

            <p class="card-text">
				<strong>Status:</strong><br>
				{{ occurrence.status }}
			</p>
		</div>
		<div class="modal fade" id="deleteModal{{ occurrence.id }}" tabindex="-1">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Confirmar exclusão</h5>
						<button class="btn-close" data-bs-dismiss="modal" type="button"></button>
					</div>

					<div class="modal-body">
						Tem certeza que deseja excluir esta denúncia?
						<br><strong>Essa ação não poderá ser desfeita.</strong>
					</div>

					<div class="modal-footer">

						<form action="{% url 'occurrence_delete' occurrence.id %}" method="post">
							{% csrf_token %}
							<button class="btn btn-danger" type="submit">
								Sim, excluir
							</button>
						</form>

						<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">
							Cancelar
						</button>
					</div>
				</div>
			</div>
		</div>

	</div>
	{% endfor %}

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
	var icons = window.LEAFLET_ICONS;

	{% for occurrence in occurrences %}
		(function () {
			var lat = parseFloat("{{ occurrence.latitude }}".replace(',', '.'));
			var lon = parseFloat("{{ occurrence.longitude }}".replace(',', '.'));
			var tipo = "{{ occurrence.crime_type }}";

			if (isNaN(lat) || isNaN(lon)) return;

			var map = L.map('map-{{ occurrence.id }}', {
				attributionControl: false,
				zoomControl: false
			}).setView([lat, lon], 15);

			L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
				maxZoom: 20
			}).addTo(map);

			L.marker([lat, lon], {icon: icons[tipo] || icons.other})
				.addTo(map);
		})();
	{% endfor %}
</script>


{% endblock %}